version: 2.1

description: Check if your CircleCI job is affected by the GitHub SSH key deprecation

commands:
  checkup:
    parameters:
      github-user-hostname:
        type: string
        default: git@github.com
    description: Greet someone with a "hello".
    steps:
      - run:
          name: Download https://github.com/github/ssh-key-algo
          command: |
            # assumes curl is available
            curl https://raw.githubusercontent.com/github/ssh-key-algo/main/ssh-key-algo > ssh-key-algo
            chmod +x ssh-key-algo
      - run:
          name: Check SSH key
          command: |
            ./ssh-key-algo << parameters.github-user-hostname >>
      - run:
          name: Check OpenSSH client
          command: |
            echo "Make sure OpenSSH client version is at least 7.2"
            ssh -V             

examples:
  basic:
    description: Use the checkup command in your job when the SSH keys are checked out.
    usage:
      version: 2.1
      orbs:
        github-ssh-key: kelvintaywl/github-ssh-key-checkup@0.0.2
      jobs:
        check-github-ssh-key-deprecation:
          parameters:
            docker-image:
              type: string
          docker:
            - image: << parameters.docker-image >>
          resource_class: small
          steps:
            - checkout
            - github-ssh-key/checkup
      workflows:
        github-ssh-key-deprecation:
          jobs:
            - check-github-ssh-key-deprecation:
                matrix:
                  parameters:
                    docker-image:
                      - circleci/python:3.10
                      - circleci/node:14
                      - circleci/golang:1.14.6
                      - circleci/php:8.0-fpm
